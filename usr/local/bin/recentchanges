#!/usr/bin/env bash
# launcher script for recentchanges			recentchanges v5.0		02/23/2026
# Note comments are for gpg 1.4 left incase trying to use an old version. Having gpg2 is default and recommended
app_install="/usr/local/recentchanges"
. "$app_install"/scripts/versionquery
. "$app_install"/scripts/validprogram.sh
. "$app_install"/scripts/rntchangesfunctions
res=1	;	USR=$(whoami)
if [[ "$1" = "-v" ]]; then get_vrn $1 ; elif [[ "$1" = "--help" ]] || [[ "$1" = "-h" ]] || [[ "$1" = "help" ]] || [[ "$1" = "-help" ]]; then get_vrn $1; fi
[[ "$1" = "query" ]] && { python3 "$app_install"/rntchanges.py $USR "$PWD" query ; exit ; }
[[ "$1" = "reset" ]] && { python3 "$app_install"/rntchanges.py $USR "$PWD" reset ; exit ; }
# if [[ $(id -u) -ne 0 ]] # if  ! id $USR >/dev/null 2>&1; then echo user: $USR not found; exit 1; fi
if [ $USR != "root" ]; then  
	setup_exports
	#alternative to launch environment for legacy and modifications gpg 1.4 and agent 2.1.11 or if needing display
	#sudo -k ; exec sudo XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" LAUNCHED_NON_ROOT="$LAUNCHED_NON_ROOT" -- "$0" $USR "$PWD" $1 "$2" $3  # change for working with 
	echo "Please enter your root password below"
	#su - root -s /bin/bash -c 'export XDG_RUNTIME_DIR="$1" ; export LAUNCHED_NON_ROOT="$2" ; exec "$3" "$4" "$5" "$6" "$7" "$8"' _ "$XDG_RUNTIME_DIR" "$LAUNCHED_NON_ROOT" "$0" "$USR" "$PWD" "$1" "$2" "$3"
	su - -c "export XDG_RUNTIME_DIR='$XDG_RUNTIME_DIR' ; export LAUNCHED_NON_ROOT='$LAUNCHED_NON_ROOT' ; '$0' '$USR' '$PWD' '$1' '$2' '$3'"  #  DISPLAY='$DISPLAY' XAUTHORITY='$XAUTHORITY'
	res=$?
	output_results
fi


if [[ -z "$LAUNCHED_NON_ROOT" ]]; then
	# if  ! id $1 >/dev/null 2>&1; then echo "$0" text editor cant be run as root. comment out this line to run as root && exit 0; fi
	setup_exports
	python3 "$app_install"/rntchanges.py $USR "$PWD" "$@"
	res=$?
	output_results
fi
#export DISPLAY=":0"
#[[ -n export XAUTHORITY=/home/$1/.Xauthority
#if [ "$XDG_SESSION_TYPE" = "wayland" ]; then ; fi
# gpg 1.4.23 and gpg-agent 2.1.11 legacy
#if ! gpg-connect-agent /bye >/dev/null 2>&1; then ## change for working with gpg 1.4 and agent 2.1.11  uncomment 38 for pid
#    green "Starting gpg-agent..."
#    eval "$(gpg-agent --daemon)"
#    #AGENT_PID=$(pgrep -u root -n gpg-agent)
#    export GPG_TTY=$(tty)
#    export GPG_AGENT_INFO=/root/.gnupg/S.gpg-agent:0:1
#fi
python3 "$app_install"/rntchanges.py "$@"
res=$?
#if [ -n "$AGENT_PID" ]; then kill "$AGENT_PID"; fi
exit $res

